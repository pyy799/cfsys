{% extends 'base1.html' %}

{% block header_js %}
    <link rel="stylesheet" href="/static/plugins/datatables/dataTables.bootstrap.css">
    <link rel="stylesheet" href="/static/css/components.css">
    <link rel="stylesheet" href="/static/css/jpage.css">
    <!-- Morris chart -->
    <link rel="stylesheet" href="/static/plugins/morris/morris.css">
{% endblock %}

{% block content %}
    <div class="box box-solid" style="padding-left: 100px;">
        <input type="hidden" id="group_login" value="{{ group_login }}">
        <input type="hidden" id="id_login" value="{{ id_login }}">
        <div><h3 class="box-header with-border" style="margin-top: 0;padding-top: 30px">用户管理</h3></div>
        <div class="box-body">
            <form style="float:left">
                <div class="col-sm-12">
                    <label for="name" style="width:50px;text-align: right">用户名</label>
                    <input type="text" id="name" name="name"
                           placeholder="请输入用户名" class="form-control input-inline" style="width:255px">
                    <label for="company" style="width:50px;text-align: right">公司</label>
                    {% if group_login == "超级管理员" %}
                        <select id="company" name="company" class="form-control input-inline" style="width:255px">
                            <option value="0" selected>所有</option>
                            <option value="1">长峰股份</option>
                            <option value="2">长峰医疗分公司</option>
                            <option value="4">长峰科技</option>
                            <option value="5">长峰科威</option>
                            <option value="6">长峰科发</option>
                            <option value="7">航天柏克</option>
                            <option value="8">航天精一</option>
                            <option value="9">朝阳电源</option>
                        </select>
                    {% else %}
                        <select id="company" name="company" class="form-control input-inline" style="width:255px">
                            <option value="{{ company_login }}" selected>{{ company_login_name }}</option>
                        </select>
                    {% endif %}
                    <label for="department" style="width:50px;text-align: right">部门</label>
                    <input type="text" id="department" name="department" class="form-control input-inline"
                           placeholder="部门" value="" style="width:255px">
                </div>
                <div class="col-sm-12" style="margin-top: 5px">
                    <label for="position" class="control-label" style="width:50px;text-align: right">职位</label>
                    <input type="text" id="position" name="position" class="form-control input-inline" placeholder="职位"
                           style="width:255px">
                    <label for="role" class="control-label" style="width:50px;text-align: right">角色</label>
                    <select type="text" id="role" name="role" class="form-control input-inline" style="width:255px">
                        <option value="0" selected>所有</option>
                        {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                    <label for="role" class="control-label" style="width:50px;text-align: right"></label>
                    <input type="button" id="search" name="search" value="查询"
                           class="btn btn-large btn-primary" style="width:255px" onclick="search_it(1)">
                </div>
            </form>
        </div>
        <div>
            <h3 class="box-header with-border">
                查询结果
                <input type="button" class="btn btn-large btn-primary" value="新增用户"
                       data-toggle="modal" data-target="#add" style="margin-left: 750px;font-size:18px"
                       onclick="goSubmit()">
            </h3>
            <div class="box-body">
                <table id="userInfo" class="table table-hover">
                    <thead>
                    <tr>
                        <th style="text-align: center">用户名</th>
                        <th style="text-align: center">性别</th>
                        <th style="text-align: center">所属公司</th>
                        <th style="text-align: center">所属部门</th>
                        <th style="text-align: center">职位</th>
                        <th style="text-align: center">角色</th>
                        <th style="text-align: center">电话</th>
                        <th style="text-align: center">邮箱</th>
                        <th style="text-align: center">创建时间</th>
                        <th style="text-align: center">用户状态</th>
                        <th style="text-align: center">操作</th>
                    </tr>
                    </thead>
                    <tbody id="user_info_table">
                    {% for user in users %}
                        <tr style="text-align: center">
                            <td id="username_{{ user.id }}">{{ user.username }}</td>
                            {% if user.gender %}
                                <td id="gender_{{ user.id }}">男</td>
                            {% else %}
                                <td id="gender_{{ user.id }}">女</td>
                            {% endif %}
                            <td id="company_{{ user.id }}">{{ user.Company }}</td>
                            <td id="department_{{ user.id }}">{{ user.department }}</td>
                            <td id="position_{{ user.id }}">{{ user.position }}</td>
                            <td id="group_{{ user.id }}">{{ user.group }}</td>
                            <td id="phone_{{ user.id }}">{{ user.phone }}</td>
                            <td id="email_{{ user.id }}">{{ user.email }}</td>
                            <td>{{ user.date_joined }}</td>
                            {% if user.is_active %}
                                <td id="active_{{ user.id }}">正在使用</td>
                            {% else %}
                                <td id="active_{{ user.id }}">已停用</td>
                            {% endif %}
                            {% if  user.group == "超级管理员" and group_login != "超级管理员" %}
                                <td>
                                    <button type="button" class="btn  btn-success btn-sm" data-toggle="modal"
                                            data-target="#modify"
                                            disabled title="你没有权限修改该用户" onclick="goModify('{{ user.id }}')">修改
                                    </button>
                                    {% if user.is_active %}
                                        <button type="button" class="btn btn-info btn-sm"
                                                onclick="changeUse('{{ user.id }}')"
                                                id="change_{{ user.id }}" disabled title="你没有权限停用该用户">停用
                                        </button>
                                    {% else %}
                                        <button type="button" class="btn  btn-info btn-sm"
                                                onclick="changeUse('{{ user.id }}')"
                                                id="change_{{ user.id }}" disabled title="你没有权限启用该用户">启用
                                        </button>
                                    {% endif %}
                                    <button type="button" class="btn  btn-danger btn-sm" data-toggle="modal"
                                            disabled title="你没有权限删除该用户"
                                            data-target="#delete"
                                            onclick="goDelete('{% url "delete_user"  user.id %}','{{ user.id }}')">删除
                                    </button>
                                </td>
                            {% else %}
                                {% if user.id == id_login %}
                                    <td>
                                        <button type="button" class="btn  btn-success btn-sm" data-toggle="modal"
                                                data-target="#modify"
                                                disabled title="你没有权限修改该用户" onclick="goModify('{{ user.id }}')">修改
                                        </button>
                                        {% if user.is_active %}
                                            <button type="button" class="btn btn-info btn-sm"
                                                    onclick="changeUse('{{ user.id }}')"
                                                    id="change_{{ user.id }}" disabled title="你没有权限停用该用户">停用
                                            </button>
                                        {% else %}
                                            <button type="button" class="btn  btn-info btn-sm"
                                                    onclick="changeUse('{{ user.id }}')"
                                                    id="change_{{ user.id }}" disabled title="你没有权限启用该用户">启用
                                            </button>
                                        {% endif %}
                                        <button type="button" class="btn  btn-danger btn-sm" data-toggle="modal"
                                                disabled title="你没有权限删除该用户"
                                                data-target="#delete"
                                                onclick="goDelete('{% url "delete_user"  user.id %}','{{ user.id }}')">
                                            删除
                                        </button>
                                    </td>
                                {% else %}
                                    <td>
                                        <button type="button" class="btn  btn-success btn-sm" data-toggle="modal"
                                                data-target="#modify"
                                                onclick="goModify('{{ user.id }}')">修改
                                        </button>
                                        {% if user.is_active %}
                                            <button type="button" class="btn btn-info btn-sm"
                                                    onclick="changeUse('{{ user.id }}')"
                                                    id="change_{{ user.id }}">停用
                                            </button>
                                        {% else %}
                                            <button type="button" class="btn  btn-info btn-sm"
                                                    onclick="changeUse('{{ user.id }}')"
                                                    id="change_{{ user.id }}">启用
                                            </button>
                                        {% endif %}
                                        <button type="button" class="btn  btn-danger btn-sm" data-toggle="modal"
                                                data-target="#delete"
                                                onclick="goDelete('{% url "delete_user"  user.id %}','{{ user.id }}')">
                                            删除
                                        </button>
                                    </td>
                                {% endif %}
                            {% endif %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="box-footer" style="text-align: center">
                <div class="col-sm-6">
                    <div class="pagination" style="float:left">共有<span id="pageCounts">{{ pageCounts }}</span>页<span
                            id="pageError"></span></div>

                </div>
                <div class="col-sm-6">
                    <ul class="pagination" style="float:right">
                        <li class="paginate_button previous"><a href=""
                                                                onclick="previous_search_it();return false;">上一页</a>
                        </li>
                        <li class="paginate_button"><a href="javascript:void(0)">第&nbsp;<span id="pageNum">1</span>&nbsp;页</a>
                        </li>
                        <li class="paginate_button next"><a onclick="next_search_it();return false;">下一页</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="add" tabindex="-1"
         role="dialog" aria-labelledby="addLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="false">&times;</button>
                    <h5 class="modal-title" id="addLabel" style="font-weight:bold">
                        新增用户(带<span style="color:red;width:20px">*</span>的选项为必填项)</h5>
                </div>
                <form style=";float:none" class="form-horizontal" method="post" action="{% url 'add_user' %}"
                      id="add_user_form">
                    {% csrf_token %}
                    <div class="modal-form" style="margin-top: 0">
                        <div class="col-sm-12" style="margin-top: 5px">
                            <label for="add_name" class="control-label" style="width:50px;text-align: right">
                                <span style="color:red;width:20px">*</span>用户名</label>
                            <input type="text" id="add_name" name="add_name"
                                   placeholder="请输入用户名" class="form-control input-inline" style="width: 200px">
                            <label for="add_gender" class="control-label"
                                   style="width:50px;text-align: right">性别</label>
                            <select id="add_gender" name="add_gender" class="form-control input-inline"
                                    style="width: 200px">
                                <option value="1" selected>男</option>
                                <option value="0">女</option>
                            </select>
                        </div>
                        <div class="col-sm-12" style="margin-top: 5px">
                            <label for="add_company" class="control-label"
                                   style="width:50px;text-align: right">公司</label>
                            {% if group_login == "超级管理员" %}
                                <select id="add_company" name="add_company" class="form-control input-inline"
                                        style="width: 200px">
                                    <option value="1">长峰股份</option>
                                    <option value="2">长峰医疗分公司</option>
                                    <option value="4">长峰科技</option>
                                    <option value="5">长峰科威</option>
                                    <option value="6">长峰科发</option>
                                    <option value="7">航天柏克</option>
                                    <option value="8">航天精一</option>
                                    <option value="9">朝阳电源</option>
                                </select>
                            {% else %}
                                <select id="add_company" name="add_company" class="form-control input-inline"
                                        style="width: 200px">
                                    <option value="{{ company_login }}" selected>{{ company_login_name }}</option>

                                </select>
                            {% endif %}
                            <label for="add_department" class="control-label"
                                   style="width:50px;text-align: right">部门</label>
                            <input type="text" id="add_department" name="add_department"
                                   class="form-control input-inline" value="" placeholder="部门名称" style="width: 200px">
                        </div>
                        <div class="col-sm-12" style="margin-top: 5px">
                            <label for="add_position" class="control-label"
                                   style="width:50px;text-align: right">职位</label>
                            <input type="text" id="add_position" name="add_position" class="form-control input-inline"
                                   value="" placeholder="职位" style="width: 200px">
                            <label for="add_role" class="control-label" style="width:50px;text-align: right">角色</label>
                            <select id="add_role" name="add_role" class="form-control input-inline"
                                    style="width: 200px">
                                {% for group in groups %}
                                    {% if group.name == "超级管理员" %}
                                        {% if group_login == "超级管理员" %}
                                            <option value="{{ group.id }}">{{ group.name }}</option>
                                        {% endif %}
                                    {% else %}
                                        <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-12" style="margin-top: 5px">
                            <label for="add_phone" class="control-label" style="width:50px;text-align: right">
                                <span style="color:red;width:20px">*</span>电话</label>
                            <input type="text" id="add_phone" name="add_phone"
                                   placeholder="请输入电话" class="form-control input-inline" style="width: 200px">
                            <label for="add_email" class="control-label" style="width:50px;text-align: right">
                                <span style="color:red;width:20px">*</span>邮箱</label>
                            <input type="text" id="add_email" name="add_email"
                                   placeholder="请输入邮箱" class="form-control input-inline" style="width: 200px">
                        </div>
                    </div>
                    <div class="col-sm-12" id="err_message" style="height:30px;margin-top: 5px;color:red"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="check_submit()">确认</button>
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <div class="modal fade" id="modify" tabindex="-1"
         role="dialog" aria-labelledby="modifyLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="false">&times;</button>
                    <h5 class="modal-title" id="modifyLabel" style="font-weight:bold">
                        修改用户信息(带<span style="color:red;width:20px">*</span>的选项为必填项)</h5>
                </div>
                <form style=";float:none" class="form-horizontal" enctype="application/x-www-form-urlencoded">
                    {% csrf_token %}
                    <div class="modal-form" style="margin-top: 0">
                        <div class="col-sm-12" style="margin-top: 5px">
                            <label for="modify_name" class="control-label" style="width:50px;text-align: right">
                                <span style="color:red;width:20px">*</span>用户名</label>
                            <input type="text" id="modify_name" name="modify_name"
                                   placeholder="请输入用户名" class="form-control input-inline" style="width: 200px">
                            <label for="modify_gender" class="control-label"
                                   style="width:50px;text-align: right">性别</label>
                            <select id="modify_gender" name="modify_gender" class="form-control input-inline"
                                    style="width: 200px">
                                <option value="1">男</option>
                                <option value="0">女</option>
                            </select>
                        </div>
                        <div class="col-sm-12" style="margin-top: 5px">
                            <label for="modify_company" class="control-label"
                                   style="width:50px;text-align: right">公司</label>
                            {% if group_login == "超级管理员" %}
                                <select id="modify_company" name="modify_company" class="form-control input-inline"
                                        style="width: 200px">
                                    <option value="1">长峰股份</option>
                                    <option value="2">长峰医疗分公司</option>
                                    <option value="4">长峰科技</option>
                                    <option value="5">长峰科威</option>
                                    <option value="6">长峰科发</option>
                                    <option value="7">航天柏克</option>
                                    <option value="8">航天精一</option>
                                    <option value="9">朝阳电源</option>
                                </select>
                            {% else %}
                                <select id="modify_company" name="modify_company" class="form-control input-inline"
                                        style="width: 200px">
                                    <option value="{{ company_login }}">{{ company_login_name }}</option>
                                </select>
                            {% endif %}
                            <label for="modify_department" class="control-label"
                                   style="width:50px;text-align: right">部门</label>
                            <input type="text" id="modify_department" name="modify_department"
                                   class="form-control input-inline" value="" placeholder="部门" style="width: 200px">
                        </div>
                        <div class="col-sm-12" style="margin-top: 5px">
                            <label for="modify_position" class="control-label"
                                   style="width:50px;text-align: right">职位</label>
                            <input type="text" id="modify_position" name="modify_position"
                                   class="form-control input-inline" value="" placeholder="职位" style="width: 200px">
                            <label for="modify_role" class="control-label"
                                   style="width:50px;text-align: right">角色</label>
                            <select id="modify_role" name="modify_role" class="form-control input-inline"
                                    style="width: 200px">
                                {% for group in groups %}
                                    {% if group.name == "超级管理员" %}
                                        {% if group_login == "超级管理员" %}
                                            <option value="{{ group.id }}">{{ group.name }}</option>
                                        {% endif %}
                                    {% else %}
                                        <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-sm-12" style="margin-top: 5px">
                            <label for="modify_phone" class="control-label" style="width:50px;text-align: right">
                                <span style="color:red;width:20px">*</span>电话</label>
                            <input type="text" id="modify_phone" name="modify_phone"
                                   placeholder="请输入电话" class="form-control input-inline" style="width: 200px">
                            <label for="modify_email" class="control-label" style="width:50px;text-align: right">
                                <span style="color:red;width:20px">*</span>邮箱</label>
                            <input type="text" id="modify_email" name="modify_email"
                                   placeholder="请输入邮箱" class="form-control input-inline" style="width: 200px">
                        </div>
                    </div>
                    <div class="col-sm-12" style="height: 30px;margin-top:5px;color:red" id="err_message2"></div>
                    <input type="hidden" id="modify_id"/>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" id="modify_it">确认</button>
                    </div>
                </form>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <div class="modal fade" id="delete" tabindex="-1"
         role="dialog" aria-labelledby="deleteLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h5 class="modal-title" id="deleteLabel" style="font-weight: bold">删除用户信息</h5>
                </div>
                <div class="modal-body" style="padding-top: 0">
                    这将删除用户&nbsp;<span id="s_delete"></span>&nbsp;在数据库中的所有信息，确认删除吗？
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger"><a href="" style="color:white" id="a_delete">确认</a>
                    </button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
    <script src="/static/plugins/jQuery/jquery-2.2.3.min.js"></script>
    <script>
        var add_time = 0
        var add_group_value

        function goDelete(text, id) {
            $('#a_delete').attr('href', text)
            $('#s_delete').html($('#username_' + id).html())
        }

        function changeUse(id) {
            $.ajax({
                url: 'active',
                type: 'get',
                data: {
                    "active_id": id
                },
                success: function (res) {
                    if (res.active === false) {
                        $('#active_' + id).html("已停用")
                        $('#change_' + id).html("启用")
                    }
                    else if (res.active === true) {
                        $('#active_' + id).html("正在使用")
                        $('#change_' + id).html("停用")
                    }
                },
                error: function (res) {
                }
            })
        }

        function goModify(id) {
            $('#err_message2').html("")
            $('#modify_id').val(id)
            $('#modify_name').val($('#username_' + id).html())
            $('#modify_department').val($('#department_' + id).html())
            $('#modify_position').val($('#position_' + id).html())
            $('#modify_phone').val($('#phone_' + id).html())
            $('#modify_email').val($('#email_' + id).html())
            var opt_gender = document.getElementById("modify_gender")
            for (var i = 0; i < opt_gender.options.length; i++) {
                if ($('#gender_' + id).html() === opt_gender.options[i].innerHTML)
                    opt_gender.options[i].selected = "selected"
            }
            var opt_com = document.getElementById("modify_company")
            for (var i = 0; i < opt_com.options.length; i++) {
                if ($('#company_' + id).html() === opt_com.options[i].innerHTML)
                    opt_com.options[i].selected = "selected"
            }
            var opt_role = document.getElementById("modify_role")
            for (var i = 0; i < opt_role.options.length; i++) {
                if ($('#group_' + id).html() === opt_role.options[i].innerHTML)
                    opt_role.options[i].selected = "selected"
            }
        }

        $('#modify_it').click(function () {
            var data = {
                'id': $("#modify_id").val(),
                'username': $.trim($('#modify_name').val()),
                'gender': $("#modify_gender").val(),
                'uCompany': $("#modify_company").val(),
                'department': $.trim($('#modify_department').val()),
                'position': $.trim($('#modify_position').val()),
                'role': $('#modify_role').val(),
                'phone': $.trim($('#modify_phone').val()),
                'email': $.trim($('#modify_email').val()),
                'csrfmiddlewaretoken': $("input[name='csrfmiddlewaretoken']").val()
            }
            if (data.username === "") {
                $('#err_message2').html("用户名不能为空!")
            }
            else if (data.phone === "") {
                $('#err_message2').html("电话号码不能为空!")
                return false
            }
            else if (!(/^[0-9]+$/.test(data.phone))) {
                $('#err_message').html("电话号码应全为数字!")
                return false
            }
            else if (data.phone.length > 11) {
                $('#err_message2').html("电话号码长度超过11位!")
                return false
            }
            else if (data.phone.length < 6) {
                $('#err_message2').html("电话号码长度小于6位!")
                return false
            }
            else if (data.email === "") {
                $('#err_message2').html("邮箱地址不能为空!")
                return false
            }
            else if (data.email.indexOf('@') === -1) {
                $('#err_message2').html("邮箱地址不含'@',无效!")
                return false
            }
            else {
                $.ajax({
                    url: 'modify/',
                    type: 'POST',
                    data: data,
                    async: true,
                    success: function (res) {
                        if (res.status === -1) {
                            $('#err_message2').html("用户名已存在!")
                        }
                        else {
                            $('#modify').modal('hide')
                            var id = data.id
                            $('#username_' + id).html(res.username)
                            if (res.gender === 1)
                                $('#gender_' + id).html('男')
                            else
                                $('#gender_' + id).html('女')
                            $('#company_' + id).html(res.Company)
                            $('#department_' + id).html(res.department)
                            $('#position_' + id).html(res.position)
                            $('#group_' + id).html(res.group)
                            $('#phone_' + id).html(res.phone)
                            $('#email_' + id).html(res.email)
                        }
                    },
                    error: function () {
                        $('#err_message2').html("服务器出错了!")
                    }
                });
                return false;
            }
        })

        function search_it(page) {
            var data = {
                'username': $('#name').val(),
                'uCompany': $('#company').val(),
                'department': $('#department').val(),
                'position': $('#position').val(),
                'group': $('#role').val(),
                'page': page,
                'csrfmiddlewaretoken': $("input[name='csrfmiddlewaretoken']").val()
            }
            var group_login = $('#group_login').val()
            var id_login = $('#id_login').val()
            $.ajax({
                url: 'search/',
                data: data,
                type: 'post',
                async: true,
                success: function (res) {

                    console.log(group_login)
                    $('#pageError').html("")
                    $('#user_info_table').html("")
                    $('#pageCounts').html(res.pageCounts)
                    $('#pageNum').html(page)
                    res.users.forEach(function (value) {
                        var deleteUrl = "/user/page_user_management/delete/" + value.id + "/"

                        var usernameString = '<td id="username_' + value.id + '">' + value.username + '</td>'
                        var genderString
                        if (value.gender === 1)
                            genderString = '<td id="gender_' + value.id + '">' + '男</td>'
                        else
                            genderString = '<td id="gender_' + value.id + '">' + '女</td>'
                        var companyString = '<td id="company_' + value.id + '">' + value.Company + '</td>'
                        var departString = '<td id="department_' + value.id + '">' + value.department + '</td>'
                        var positionString = '<td id="position_' + value.id + '">' + value.position + '</td>'
                        var groupString = '<td id="group_' + value.id + '">' + value.group + '</td>'
                        var phoneString = '<td id="phone_' + value.id + '">' + value.phone + '</td>'
                        var emailString = '<td id="email_' + value.id + '">' + value.email + '</td>'
                        var dateString = '<td>' + value.date_joined + '</td>'
                        var activeString
                        var useString
                        var modifyString
                        var deleteString
                        if (value.is_active === true) {
                            activeString = '<td id="active_' + value.id + '">' + '正在使用</td>'
                            if ((value.group === "超级管理员" && group_login !== "超级管理员") || id_login == value.id) {
                                useString = '<button type="button"class="btn btn-info btn-sm" onclick="changeUse('
                                    + value.id + ')" id="change_' + value.id + '" disabled title="你没有权限停用该用户">停用</button>'
                            }
                            else {
                                useString = '<button type="button"class="btn btn-info btn-sm" onclick="changeUse('
                                    + value.id + ')" id="change_' + value.id + '">停用</button>'
                            }
                        }
                        else {
                            activeString = '<td id="active_' + value.id + '">' + '已停用</td>'
                            if ((value.group === "超级管理员" && group_login !== "超级管理员") || id_login == value.id) {
                                useString = '<button type="button"class="btn btn-info btn-sm" onclick="changeUse('
                                    + value.id + ')" id="change_' + value.id + '" disabled title="你没有权限启用该用户">启用</button>'
                            }
                            else {
                                useString = '<button type="button"class="btn btn-info btn-sm" onclick="changeUse('
                                    + value.id + ')" id="change_' + value.id + '">启用</button>'
                            }

                        }
                        if ((value.group === "超级管理员" && group_login !== "超级管理员") || id_login == value.id) {
                            modifyString = '<button type="button"class="btn  btn-success btn-sm" data-toggle="modal" data-target="#modify"'
                                + 'onclick="goModify(' + value.id + ')" disabled title="你没有权限修改该用户">修改</button>'
                            deleteString = '<button type="button" class="btn  btn-danger btn-sm" data-toggle="modal"' + 'data-target="#delete" onclick="goDelete('
                                + "'" + deleteUrl + "'" + ',' + value.id
                                + ')" disabled title="你没有权限删除该用户">删除</button>'
                        }
                        else {
                            modifyString = '<button type="button"class="btn  btn-success btn-sm" data-toggle="modal" data-target="#modify"'
                                + 'onclick="goModify(' + value.id + ')">修改</button>'
                            deleteString = '<button type="button" class="btn  btn-danger btn-sm" data-toggle="modal"' + 'data-target="#delete" onclick="goDelete('
                                + "'" + deleteUrl + "'" + ',' + value.id
                                + ')">删除</button>'
                        }

                        $('#user_info_table').append('<tr style="text-align: center">' + usernameString + genderString +
                            companyString + departString + positionString + groupString + phoneString + emailString + dateString + activeString
                            + '<td>' + modifyString + useString + deleteString + '</td></tr>')
                    })
                },
                error: function () {
                }
            })
        }

        function next_search_it() {
            var next_page = parseInt($('#pageNum').html()) + 1
            if (next_page <= parseInt($('#pageCounts').html())) {
                search_it(next_page)
                $('#pageError').html("")
            }
            else {
                $('#pageError').html(",这是最后一页了")
            }
        }

        function previous_search_it() {
            var previous_page = parseInt($('#pageNum').html()) - 1
            if (previous_page <= 0) {
                $('#pageError').html(",没有上一页了")
            }
            else {
                search_it(previous_page)
                $('#pageError').html("")
            }
        }

        function goSubmit() {
            if (add_time === 0) {
                add_group_value = $('#add_role').val()
                add_time = 1
            }
            else {
                $('#add_role').val(add_group_value)
            }
            $('#err_message').html("")
            $('#add_name').val("")
            $('#add_gender').val("1")
            $('#add_company').val("1")
            $('#add_department').val("")
            $('#add_position').val("")
            $('#add_phone').val("")
            $('#add_email').val("")
        }

        function check_submit() {
            var username = $.trim($('#add_name').val())
            var phone = $.trim($('#add_phone').val())
            var email = $.trim($('#add_email').val())
            if (username === "") {
                $('#err_message').html("用户名不能为空!")
                return false
            }
            else if (phone === "") {
                $('#err_message').html("电话号码不能为空!")
                return false
            }
            else if (!(/^[0-9]+$/.test(phone))) {
                $('#err_message').html("电话号码应全为数字!")
                return false
            }
            else if (phone.length > 11) {
                $('#err_message').html("电话号码长度超过11位!")
                return false
            }
            else if (phone.length < 6) {
                $('#err_message').html("电话号码长度小于6位!")
                return false
            }
            else if (email === "") {
                $('#err_message').html("邮箱地址不能为空!")
                return false
            }
            else if (email.indexOf('@') === -1) {
                $('#err_message').html("邮箱地址不含'@',无效!")
                return false
            }
            else {
                $.ajax({
                    url: 'user_check',
                    type: 'get',
                    data: {"username": username},
                    success: function (res) {
                        if (res.status === -1) {
                            $('#err_message').html("用户名已存在!")
                        }
                        else {
                            $('#err_message').html("")
                            $('#add_user_form').submit()
                            $('#add').modal("hide")
                        }
                    },
                    error: function () {
                        $('#err_message').html("服务器出错了!")
                    }
                })
            }
        }
    </script>
{% endblock %}

{% block footer_js %}
    <!-- Morris.js charts -->
    <script src="/static/js/raphael/raphael-min.js"></script>
    <script src="/static/plugins/morris/morris.min.js"></script>
    <script src="/static/plugins/jquery.blockui.min.js"></script>
    <script src="/static/plugins/datatables/jquery.dataTables.js"></script>
    <script src="/static/plugins/datatables/dataTables.bootstrap.min.js"></script>
    <script src="/static/js/metronic.js"></script>
    <script src="/static/js/table-ext.js"></script>
    <script src="/static/js/datatable.js"></script>
    <script src="/static/js/jPages.js"></script>
{% endblock %}
